<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Netlify Identity Widget Script -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A091A;
            color: #E0E0E0;
        }
        #background-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(at 20% 20%, hsla(224, 82%, 57%, 0.2) 0px, transparent 50%),
                radial-gradient(at 80% 20%, hsla(283, 72%, 52%, 0.2) 0px, transparent 50%),
                radial-gradient(at 20% 80%, hsla(333, 72%, 52%, 0.2) 0px, transparent 50%),
                radial-gradient(at 80% 80%, hsla(173, 72%, 52%, 0.2) 0px, transparent 50%);
            z-index: -1;
        }
        .screen {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            width: 100%;
        }
        .screen.hidden {
            display: none;
        }
        .glass-card {
            background: rgba(17, 24, 39, 0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.875rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px -5px rgba(79, 70, 229, 0.5);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            background: #5a52d6;
            box-shadow: 0 0 30px -5px rgba(79, 70, 229, 0.8);
        }
        .btn-danger {
            background: #dc2626;
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.875rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px -5px rgba(220, 38, 38, 0.5);
        }
        .btn-danger:hover {
            transform: translateY(-3px);
            background: #b91c1c;
            box-shadow: 0 0 30px -5px rgba(220, 38, 38, 0.8);
        }
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .form-input, .form-select, .form-textarea {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 0.875rem;
            transition: all 0.2s ease;
            color: #E0E0E0;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #111827 inset !important;
            -webkit-text-fill-color: #E0E0E0 !important;
        }
        .form-select option {
            background: #111827;
        }
        #summaryContent h2 { font-size: 1.5rem; font-weight: 700; color: #4f46e5; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem; }
        #summaryContent h3 { font-size: 1.125rem; font-weight: 600; color: #E0E0E0; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        #summaryContent p { color: #A0A0A0; }
        #summaryContent strong { color: #C0C0C0; }
        #summaryContent ul { list-style-type: disc; padding-left: 1.5rem; }
        #summaryContent .summary-block { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 1rem; border-radius: 1rem; margin-bottom: 1rem;}
        
        #drawer { transition: transform 0.3s ease-in-out; }
        #drawer-backdrop { transition: opacity 0.3s ease-in-out; }
        #drawer-content { padding: 0; }
        .drawer-card { box-shadow: 0 -10px 20px -5px rgba(0,0,0,0.2); flex-grow: 1; overflow-y: auto; }
        #interview-history-list li:hover { background-color: #f3f4f6; }

        .header-login-btn { border: 2px solid #3b82f6; color: #e0e0e0; padding: 0.5rem 1.5rem; border-radius: 9999px; font-weight: 500; transition: all 0.2s ease; }
        .header-login-btn:hover { background-color: #3b82f6; color: white; }
        .feature-item { color: #9ca3af; transition: color 0.2s ease; }
        .feature-item:hover { color: #3b82f6; }
        .feature-item svg { width: 4rem; height: 4rem; margin-bottom: 1rem; }
        .start-interview-home-btn { border: 2px solid #3b82f6; color: #e0e0e0; padding: 0.75rem 2rem; border-radius: 9999px; font-weight: 600; transition: all 0.2s ease; }
        .start-interview-home-btn:hover { background-color: #3b82f6; color: white; }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.5s ease-in-out;
        }
        
        #userVideoContainer {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 128px;
            height: 128px;
            border-radius: 9999px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            z-index: 10;
            transition: all 0.5s ease-in-out;
        }
        #userVideoContainer video { transform: scaleX(-1); border-radius: 9999px;}

        #aiVideoContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: all 0.5s ease-in-out;
            border-radius: 1rem;
            overflow: hidden;
            background-color: #1a1a2e;
        }
        #aiVideoContainer video { border-radius: 1rem; }
        
        /* Swapped State */
        .swapped #userVideoContainer {
            width: 100%;
            height: 100%;
            border-radius: 1rem;
            bottom: 0;
            right: 0;
            border: none;
            cursor: default;
            z-index: 0;
        }
        .swapped #userVideoContainer video { border-radius: 1rem; }

        .swapped #aiVideoContainer {
            width: 128px;
            height: 128px;
            border-radius: 9999px;
            bottom: 1rem;
            right: 1rem;
            top: auto;
            left: auto;
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            z-index: 10;
        }
        .swapped #aiVideoContainer video { border-radius: 9999px; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animated-element { opacity: 0; }
        .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        .animation-delay-200 { animation-delay: 200ms; }
        .animation-delay-400 { animation-delay: 400ms; }
        .animation-delay-600 { animation-delay: 600ms; }

        /* Hide Scrollbar */
        .scrollable-content::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }
        .scrollable-content {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="background-gradient"></div>

    <!-- Features Modal -->
    <div id="featuresModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl p-8 relative">
            <button id="closeFeaturesModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-2xl font-bold mb-6 text-center text-white">Features & Updates</h3>
            <div class="space-y-4 text-gray-300 max-h-[70vh] overflow-y-auto pr-4">
                <div>
                    <h4 class="font-semibold text-lg text-blue-400">Real-Time AI Feedback</h4>
                    <p>Get instant feedback on your answers, including suggestions for improvement and ideal responses, all powered by advanced AI.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-blue-400">Multi-Language Support</h4>
                    <p>Practice your interview in either English or Hinglish to get comfortable in the language of your choice.</p>
                </div>
                 <div>
                    <h4 class="font-semibold text-lg text-blue-400">Personalized Experience</h4>
                    <p>Tailor your mock interview by providing a specific job title and description. The AI will ask relevant questions based on the role.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-blue-400">[NEW] Complete UI Overhaul</h4>
                    <p>We've launched a brand new, sleek user interface to make your practice sessions more engaging and intuitive.</p>
                </div>
                 <div>
                    <h4 class="font-semibold text-lg text-blue-400">[NEW] Interview History</h4>
                    <p>Login to save and review your past interview summaries. Track your progress over time!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="glass-card p-6 w-full max-w-sm text-white shadow-xl">
            <h3 id="confirmModalTitle" class="text-lg font-bold mb-4">Are you sure?</h3>
            <p id="confirmModalText" class="text-sm mb-6 text-gray-300">This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmCancelBtn" class="px-4 py-2 rounded-lg btn-secondary">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">Delete</button>
            </div>
        </div>
    </div>

    <!-- Drawer -->
    <div id="drawer" class="fixed top-0 right-0 h-full w-80 bg-[#111827] shadow-2xl z-40 transform translate-x-full">
        <div id="drawer-content" class="flex flex-col h-full">
            <!-- Drawer content will be populated by JavaScript -->
        </div>
    </div>
    <div id="drawer-backdrop" class="fixed inset-0 bg-black/50 z-30 hidden opacity-0"></div>

    <!-- Main Header -->
    <header id="appHeader" class="w-full max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center text-white flex-shrink-0">
        <h1 class="text-xl font-bold">Interview Mok-Ai</h1>
        <nav class="hidden md:flex items-center space-x-8">
            <a href="#" id="homeLink" class="text-gray-300 hover:text-white transition-colors">Home</a>
            <a href="#" id="featuresLink" class="text-gray-300 hover:text-white transition-colors">Features</a>
        </nav>
        <div class="flex items-center">
            <div id="header-auth-section" class="flex items-center">
                <!-- Login/Profile button will be injected here -->
            </div>
             <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden p-2 ml-2 rounded-md text-gray-300 hover:text-white hover:bg-white/10 focus:outline-none">
                <span class="sr-only">Open main menu</span>
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>
    </header>
    
    <!-- Mobile Menu, shown/hidden based on button click -->
    <div id="mobile-menu" class="hidden md:hidden bg-gray-800/50 backdrop-blur-sm">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="#" id="mobileHomeLink" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Home</a>
            <a href="#" id="mobileFeaturesLink" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Features</a>
        </div>
    </div>

    <main class="flex-grow p-4 overflow-y-auto">
        <div id="app" class="w-full">
            
            <!-- Home Screen -->
            <div id="homeScreen" class="screen w-full max-w-4xl mx-auto text-center py-12">
                <h2 class="text-4xl md:text-6xl font-extrabold text-white animated-element">Interview Mok-Ai:</h2>
                <p class="text-2xl md:text-4xl font-semibold text-gray-300 mt-2 animated-element animation-delay-200">Crack Your Next Interview With Confidence</p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-8 md:gap-12 my-16 animated-element animation-delay-400">
                    <div class="feature-item flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 016 0v8.25a3 3 0 01-3 3z" /></svg>
                        <span class="font-semibold">Mock Interview</span>
                    </div>
                    <div class="feature-item flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V5.25a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v13.5a2.25 2.25 0 002.25 2.25z" /></svg>
                         <span class="font-semibold">AI Feedback</span>
                    </div>
                    <div class="feature-item flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.63 2.25a14.98 14.98 0 00-5.84 7.38m5.84 2.58v-4.8m0 4.8a6 6 0 01-3.36 5.23m3.36-5.23a6 6 0 013.36 5.23m0 0a6 6 0 01-5.84-7.38m5.84 7.38a14.98 14.98 0 00-3.36-5.23m-2.48 5.23a14.98 14.98 0 01-3.36-5.23m0 0a14.98 14.98 0 01-5.84-7.38" /></svg>
                        <span class="font-semibold">HR + Tech Round</span>
                    </div>
                    <div class="feature-item flex flex-col items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="font-semibold">Real-Time Practice</span>
                    </div>
                </div>

                <button id="startInterviewHomeBtn" class="start-interview-home-btn animated-element animation-delay-600">Start Interview</button>
            </div>

            <!-- Setup Screen -->
            <div id="setupScreen" class="screen hidden w-full max-w-3xl mx-auto py-12">
                <div class="glass-card p-8 space-y-6">
                    <div class="text-center">
                        <h1 class="text-4xl font-extrabold text-white" data-lang-key="main_title">AI Interview Coach</h1>
                        <p class="text-gray-400 mt-2" data-lang-key="tagline">Practice for your dream job.</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="languageSelector" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="select_language">Interview Language</label>
                            <select id="languageSelector" class="form-select w-full">
                                <option value="en">English</option>
                                <option value="hi">Hinglish</option>
                            </select>
                        </div>
                        <div>
                            <label for="jobTitle" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="job_title_label">Job Title</label>
                            <input type="text" id="jobTitle" class="form-input w-full" placeholder="e.g., Senior Software Engineer">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="jobDescription" class="block text-sm font-medium text-gray-300" data-lang-key="job_desc_label">Job Description</label>
                                <button id="generateDescBtn" class="text-sm text-indigo-400 hover:text-indigo-300 font-semibold" data-lang-key="generate_desc_btn">Generate Description</button>
                            </div>
                            <textarea id="jobDescription" rows="6" class="form-textarea w-full" data-lang-key="job_desc_placeholder" placeholder="Paste job description here..."></textarea>
                        </div>
                        <div>
  <label for="resumeUpload" class="block text-sm font-medium text-gray-300 mb-2">
    Upload Resume (PDF/DOCX/TXT)
  </label>
  <input type="file" id="resumeUpload" accept=".pdf,.doc,.docx,.txt" 
         class="form-input w-full cursor-pointer">
  <p id="resumeStatus" class="text-xs text-gray-400 mt-2"></p>
</div>

                        <div>
                            <label for="difficulty" class="block text-sm font-medium text-gray-300 mb-2" data-lang-key="difficulty_label">Difficulty Level</label>
                            <select id="difficulty" class="form-select w-full">
                                <option value="Easy" data-lang-key="difficulty_easy">Easy</option>
                                <option value="Medium" selected data-lang-key="difficulty_medium">Medium</option>
                                <option value="Hard" data-lang-key="difficulty_hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    <button id="startInterviewBtn" class="w-full btn-primary" data-lang-key="start_btn">
                        Start Practice
                    </button>
                </div>
            </div>

            <!-- Interview Screen -->
            <div id="interviewScreen" class="screen hidden w-full max-w-7xl mx-auto h-full">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 h-full p-4">
                    
                    <!-- Left Column -->
                    <div class="lg:col-span-3 flex flex-col gap-6 h-full">
                        <div class="glass-card p-4 sm:p-6 flex-grow flex flex-col h-full">
                           <div id="videoFeedContainer" class="video-container flex-grow bg-black/20 rounded-xl flex items-center justify-center relative min-h-[300px] md:min-h-[400px] overflow-hidden">
                                <!-- AI Agent Video -->
                                <div id="aiVideoContainer">
                                    <video id="aiAvatarVideo" class="w-full h-full object-cover" loop playsinline></video>
                                </div>
                                <!-- User Video -->
                                <div id="userVideoContainer">
                                    <video id="videoElement" class="hidden w-full h-full object-cover" autoplay muted playsinline></video>
                                    <div id="videoPlaceholder" class="w-full h-full flex items-center justify-center bg-gray-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                    </div>
                                </div>
                           </div>
                           <div class="flex justify-center items-center gap-4 sm:gap-6 mt-4 pt-4 border-t border-white/10 flex-shrink-0">
                               <button id="micBtn" class="bg-white/10 p-3 sm:p-4 rounded-full text-white hover:bg-white/20 transition-colors">
                                   <span class="sr-only">Toggle Microphone</span>
                                   <svg class="mic-on-icon h-5 w-5 sm:h-6 sm:w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                                   <svg class="mic-off-icon hidden h-5 w-5 sm:h-6 sm:w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-2 2m0 0l-2 2m2-2l2 2m-2-2l-2-2M5 9l2 2m0 0l2 2M7 11l2-2m-2 2l-2-2m6-3a2 2 0 11-4 0 2 2 0 014 0zM5 19a2 2 0 002 2h10a2 2 0 002-2v-3a2 2 0 00-2-2H7a2 2 0 00-2 2v3z" /></svg>
                               </button>
                               <button id="videoBtn" class="bg-white/10 p-3 sm:p-4 rounded-full text-white hover:bg-white/20 transition-colors">
                                   <span class="sr-only">Toggle Camera</span>
                                   <svg class="video-on-icon h-5 w-5 sm:h-6 sm:w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                   <svg class="video-off-icon hidden h-5 w-5 sm:h-6 sm:w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1l22 22" /></svg>
                               </button>
                               <button id="endInterviewBtn" class="bg-red-600 p-3 sm:p-4 rounded-full text-white hover:bg-red-700 transition-colors">
                                   <span class="sr-only">End Interview</span>
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                               </button>
                           </div>
                           <div class="mt-4 pt-4 border-t border-white/10 flex-grow flex flex-col min-h-0">
                                <h3 class="font-bold text-lg mb-2 text-gray-300 flex-shrink-0" data-lang-key="your_answer_label">Aapka Jawab</h3>
                                <div class="bg-black/20 p-4 rounded-xl flex-grow overflow-y-auto scrollable-content">
                                    <p id="userTranscript" class="text-gray-400 italic" data-lang-key="transcript_placeholder">Aapka bola hua jawab yahan dikhega...</p>
                                </div>
                                <div id="statusIndicator" class="flex items-center space-x-3 p-3 w-fit mt-2 flex-shrink-0">
                                    <div id="statusIconContainer"></div>
                                    <span id="statusText" class="text-gray-300 font-medium text-sm" data-lang-key="status_waiting">Waiting...</span>
                                </div>
                           </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="lg:col-span-2 flex flex-col gap-6 h-full">
                        <!-- AI Coach Card -->
                        <div class="glass-card p-6 flex flex-col flex-grow min-h-0">
                            <h3 id="interviewTitle" class="font-bold text-lg mb-4 text-indigo-400 flex-shrink-0">Interview Coach</h3>
                            <div class="bg-black/20 p-4 rounded-xl flex-grow flex flex-col justify-center overflow-y-auto scrollable-content">
                               <div id="aiQuestion" class="text-lg text-white font-medium text-center">Coach taiyaar ho raha hai...</div>
                            </div>
                        </div>

                        <!-- Hint Button -->
                        <button id="hintBtn" class="w-full btn-secondary text-white font-bold py-3 px-4 rounded-lg hidden" data-lang-key="hint_btn">Hint Chahiye?</button>

                        <!-- Feedback Card -->
                        <div id="feedbackContainer" class="glass-card p-6 flex-col flex-grow min-h-0 hidden">
                             <h3 class="font-bold text-lg mb-2 text-yellow-400 flex-shrink-0" data-lang-key="feedback_label">Feedback</h3>
                             <div id="aiFeedback" class="bg-black/20 p-4 rounded-xl flex-grow overflow-y-auto scrollable-content text-yellow-200">
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Screen -->
            <div id="summaryScreen" class="screen hidden w-full max-w-3xl mx-auto py-12">
                 <div class="glass-card p-8 space-y-6">
                    <div class="text-center">
                        <h1 class="text-3xl font-bold text-white" data-lang-key="summary_title">Interview Summary Report</h1>
                        <div id="status-display-container" class="mt-4">
                            <!-- Status will be injected here -->
                        </div>
                        <p class="text-gray-400 mt-2" data-lang-key="summary_tagline">Aapke performance ka detailed analysis.</p>
                    </div>
                    <div id="summaryContent" class="bg-black/20 p-6 rounded-xl space-y-4 border border-white/10 max-h-[60vh] overflow-y-auto scrollable-content">
                        <div id="summaryPlaceholder" class="flex justify-center items-center h-40">
                            <svg class="animate-spin h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    <button id="restartBtn" class="w-full btn-primary" data-lang-key="restart_btn">
                        Naya Interview Start Karein
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full text-center p-4 text-gray-500 text-sm flex-shrink-0">
        <p>&copy; 2024 AI Interview Coach. All Rights Reserved.</p>
    </footer>

    <script>
        // --- DOM Elements ---
        const drawer = document.getElementById('drawer');
        const drawerBackdrop = document.getElementById('drawer-backdrop');
        const drawerContent = document.getElementById('drawer-content');
        const headerAuthSection = document.getElementById('header-auth-section');

        const featuresModal = document.getElementById('featuresModal');
        const closeFeaturesModalBtn = document.getElementById('closeFeaturesModalBtn');
        
        const homeScreen = document.getElementById('homeScreen');
        const setupScreen = document.getElementById('setupScreen');
        const interviewScreen = document.getElementById('interviewScreen');
        const summaryScreen = document.getElementById('summaryScreen');

        const startInterviewHomeBtn = document.getElementById('startInterviewHomeBtn');
        const startInterviewBtn = document.getElementById('startInterviewBtn');
        
        const endInterviewBtn = document.getElementById('endInterviewBtn');
        const restartBtn = document.getElementById('restartBtn');
        const generateDescBtn = document.getElementById('generateDescBtn');
        const hintBtn = document.getElementById('hintBtn');
        const languageSelector = document.getElementById('languageSelector');
        const jobTitleInput = document.getElementById('jobTitle');
        const jobDescriptionInput = document.getElementById('jobDescription');
        const difficultyInput = document.getElementById('difficulty');
        const interviewTitle = document.getElementById('interviewTitle');
        const aiQuestion = document.getElementById('aiQuestion');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusIconContainer = document.getElementById('statusIconContainer');
        const statusText = document.getElementById('statusText');
        const userTranscript = document.getElementById('userTranscript');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const aiFeedback = document.getElementById('aiFeedback');
        const summaryContent = document.getElementById('summaryContent');
        const summaryPlaceholder = document.getElementById('summaryPlaceholder');

        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileHomeLink = document.getElementById('mobileHomeLink');
        const mobileFeaturesLink = document.getElementById('mobileFeaturesLink');
        const homeLink = document.getElementById('homeLink');
        const featuresLink = document.getElementById('featuresLink');
        const resumeUpload = document.getElementById('resumeUpload');
        const resumeStatus = document.getElementById('resumeStatus');
        let resumeText = "";


        // --- Media Elements ---
        const micBtn = document.getElementById('micBtn');
        const videoBtn = document.getElementById('videoBtn');
        const videoElement = document.getElementById('videoElement');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const aiVideoContainer = document.getElementById('aiVideoContainer');
        const userVideoContainer = document.getElementById('userVideoContainer');
        const videoFeedContainer = document.getElementById('videoFeedContainer');
        const aiAvatarVideo = document.getElementById('aiAvatarVideo');

        // --- Speech Recognition & Synthesis ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let endOfSpeechTimeout;
        let noResponseTimeout;
        let englishVoice, hindiVoice;

        // --- State Management ---
        let conversationHistory = [];
        let interviewLog = [];
        let currentQuestion = "";
        let isListening = false;
        let isInterviewActive = false;
        let currentLang = 'en';
        let loginAndStart = false; 
        let userStream = null;
        let isMicOn = true;
        let isVideoOn = true;
        let noResponseCounter = 0;
        
        const videoStates = {
            speaking: 'https://storage.googleapis.com/gemini-prod.appspot.com/669f744572522_Professional_Interviewer_Video_Generated.mp4',
            listening: 'https://videos.pexels.com/video-files/856722/856722-hd_1280_720_25fps.mp4',
            thinking: 'https://videos.pexels.com/video-files/7578809/7578809-hd_1920_1080_25fps.mp4'
        };

        // --- Translation Strings ---
        const translations = {
            en: { main_title: "AI Interview Coach", tagline: "Practice for your dream job.", select_language: "Interview Language", job_title_label: "Job Title", job_desc_label: "Job Description", generate_desc_btn: "Generate Description", job_desc_placeholder: "Paste job description here...", difficulty_label: "Difficulty Level", difficulty_easy: "Easy", difficulty_medium: "Medium", difficulty_hard: "Hard", start_btn: "Start Practice", interview_in_progress: "Interview in Progress...", ai_question_label: "AI COACH", your_answer_label: "Your Answer", status_waiting: "Waiting to start...", transcript_placeholder: "Your spoken answer will appear here...", feedback_label: "Feedback", hint_btn: "Need a Hint?", end_btn: "End Interview", summary_title: "Interview Summary Report", summary_tagline: "A detailed analysis of your performance.", summary_generating: "Generating your report...", restart_btn: "Start New Interview", status_listening: "Listening...", status_processing: "Processing...", status_thinking: "AI Coach is thinking...", status_generating_desc: "Generating description...", status_generating_hint: "Preparing a hint...", status_ready: "Ready", status_mic_error: "Mic error. Check permissions.", status_network_error: "Network error. Check connection.", status_no_speech: "Didn't hear that. Please repeat.", alert_no_jd: "Please enter a job description to start.", alert_no_title_for_jd: "Please enter a job title to generate a description.", video_permission_error: "Camera access denied. Please allow camera and microphone access in your browser settings.", reminder_no_response: "I'm waiting for your answer. You can start speaking now.", ending_interview_silence: "Since there's no response, I'll be ending this interview session. Feel free to start a new one anytime!" },
            hi: { main_title: "AI Interview Coach", tagline: "Apne dream job ke liye practice karein.", select_language: "Interview Language", job_title_label: "Job Title", job_desc_label: "Job Description", generate_desc_btn: "Description Generate Karein", job_desc_placeholder: "Job description yahan paste karein...", difficulty_label: "Difficulty Level", difficulty_easy: "Easy", difficulty_medium: "Medium", difficulty_hard: "Hard", start_btn: "Practice Shuru Karein", interview_in_progress: "Interview chal raha hai...", ai_question_label: "AI COACH", your_answer_label: "Aapka Jawab", status_waiting: "Start hone ka wait hai...", transcript_placeholder: "Aapka bola hua jawab yahan dikhega...", feedback_label: "Feedback", hint_btn: "Hint Chahiye?", end_btn: "Interview End Karein", summary_title: "Interview Summary Report", summary_tagline: "Aapke performance ka detailed analysis.", summary_generating: "Aapki report generate ho rahi hai...", restart_btn: "Naya Interview Start Karein", status_listening: "Suna ja raha hai...", status_processing: "Process ho raha hai...", status_thinking: "AI Coach soch raha hai...", status_generating_desc: "Description generate ho rahi hai...", status_generating_hint: "Hint taiyaar ho raha hai...", status_ready: "Ready", status_mic_error: "Mic error. Permissions check karein.", status_network_error: "Network error. Connection check karein.", status_no_speech: "Kuch sunai nahi diya. Please repeat karein.", alert_no_jd: "Start karne ke liye please job description dalein.", alert_no_title_for_jd: "Description generate karne ke liye please job title dalein.", video_permission_error: "Camera access nahi mila. Please browser settings mein camera aur microphone access allow karein.", reminder_no_response: "Main aapke jawab ka intezaar kar raha hoon. Aap ab bol sakte hain.", ending_interview_silence: "Koi jawab na milne par, main is interview ko abhi ke liye end kar raha hoon. Aap jab chahein naya interview shuru kar sakte hain!" }
        };

        // --- UI Functions ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.toggle('hidden', screen.id !== screenId);
            });
             if (screenId === 'interviewScreen') {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }

            if (screenId === 'homeScreen') {
                const elements = document.querySelectorAll('#homeScreen .animated-element');
                elements.forEach(el => {
                    el.classList.remove('animate-fade-in-up');
                    void el.offsetWidth; 
                    el.classList.add('animate-fade-in-up');
                });
            }
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });
        }

        const icons = {
            waiting: `<div class="w-3 h-3 bg-gray-500 rounded-full animate-pulse"></div>`,
            listening: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400 animate-pulse" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H7a1 1 0 100 2h6a1 1 0 100-2h-2v-2.07z" clip-rule="evenodd" /></svg>`,
            thinking: `<svg class="animate-spin h-5 w-5 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`,
            error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`
        };

        function updateStatus(key, iconType) {
            statusText.textContent = translations[currentLang][key] || key;
            statusIconContainer.innerHTML = icons[iconType] || icons.waiting;
        }
        
        function displayInterviewStatus(status) {
            const container = document.getElementById('status-display-container');
            let bgColor = 'bg-gray-500/20';
            let textColor = 'text-gray-300';
            let statusText = status;

            if (status === 'Strong Hire') {
                bgColor = 'bg-green-500/20';
                textColor = 'text-green-400';
            } else if (status === 'Good Potential') {
                bgColor = 'bg-yellow-500/20';
                textColor = 'text-yellow-400';
            } else if (status === 'Needs Improvement') {
                bgColor = 'bg-red-500/20';
                textColor = 'text-red-400';
            }

            container.innerHTML = `
                <div class="inline-block px-4 py-2 rounded-full ${bgColor} ${textColor} border border-current">
                    <span class="font-bold">Overall Status:</span> ${statusText}
                </div>
            `;
        }

        // --- Speech & AI Functions ---
        function setupSpeechSynthesis() {
            const voices = speechSynthesis.getVoices();
            englishVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google'));
            // Prioritize a specific, high-quality female Hindi voice if available
            hindiVoice = voices.find(v => v.name === 'Google ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä') || 
                         voices.find(v => v.lang === 'hi-IN' && v.name.includes('Google')) ||
                         voices.find(v => v.lang === 'hi-IN');
        }

async function speak(text, onEndCallback, isReminder = false) {
  try {
    // ‚öôÔ∏è  Detect which language toggle is active
    // Example: a global variable or button selection
    const lang = currentLang === "english" ? "english" : "hinglish";

    const response = await fetch("/.netlify/functions/speak", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text, lang }),
    });

    if (!response.ok) throw new Error("Voice fetch failed");

    const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);

    setAIAvatarState("speaking");
    audio.onended = () => {
      setAIAvatarState("listening");
      if (onEndCallback) onEndCallback();
    };

    await audio.play();
  } catch (err) {
    console.error("Voice playback error:", err);
  }
}


        function startListening() {
            if (!recognition || isListening || !isMicOn) return;
            isListening = true;
            recognition.lang = currentLang === 'hi' ? 'hi-IN' : 'en-IN';
            updateStatus('status_listening', 'listening');
            recognition.start();
        }
        
        function stopListening() {
            if (!recognition || !isListening) return;
            isListening = false;
            recognition.stop();
            clearTimeout(endOfSpeechTimeout);
            clearTimeout(noResponseTimeout);
            updateStatus('status_processing', 'thinking');
        }

       async function callGeminiAPI(history, purpose = "interview") {
            setAIAvatarState('thinking');
            let statusKey = 'status_thinking';
            if (purpose === 'description') statusKey = 'status_generating_desc';
            if (purpose === 'hint') statusKey = 'status_generating_hint';
            updateStatus(statusKey, 'thinking');
        
            try {
                const response = await fetch('/.netlify/functions/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: history })
                });
        
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
        
                const result = await response.json();
        
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                }
                throw new Error(result.error || "No response from AI.");
        
            } catch (error) {
                console.error("API Error:", error);
                speak(translations[currentLang].status_network_error, () => updateStatus('status_network_error', 'error'));
                return null;
            }
        }
        
        // --- Core Logic Functions ---
        function handleNoResponse() {
            if (!isInterviewActive) return;
            noResponseCounter++;
            if (noResponseCounter >= 3) {
                speak(translations[currentLang].ending_interview_silence, () => endInterview(), true);
            } else {
                speak(translations[currentLang].reminder_no_response, () => {
                    if (isInterviewActive) startNoResponseTimer();
                }, true);
            }
        }

        function startNoResponseTimer() {
            clearTimeout(noResponseTimeout);
            noResponseTimeout = setTimeout(handleNoResponse, 10000); // 10 seconds
        }

        async function handleInterviewTurn(userAnswer) {
             clearTimeout(noResponseTimeout);
             noResponseCounter = 0;
             hintBtn.classList.add('hidden');
             
             let turnHistory = [...conversationHistory];
             if(userAnswer) {
                turnHistory.push({ role: "user", parts: [{ text: userAnswer }] });
             }

             const aiResponseText = await callGeminiAPI(turnHistory, "interview");
             
             if(aiResponseText){
                 if(userAnswer) {
                    conversationHistory.push({ role: "user", parts: [{ text: userAnswer }] });
                 }
                 conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                 const parts = aiResponseText.split('|||');
                 let feedback = "", idealAnswerPoints = "", nextQuestion = "";

                 if (parts.length === 3) {
                     [feedback, idealAnswerPoints, nextQuestion] = parts.map(p => p.trim());
                     if(currentQuestion && userTranscript.textContent !== translations[currentLang].transcript_placeholder){
                         interviewLog.push({ question: currentQuestion, userAnswer: userTranscript.textContent, feedback, idealAnswer: idealAnswerPoints });
                     }
                 } else {
                     nextQuestion = aiResponseText;
                 }
                 currentQuestion = nextQuestion;
                 
                 if (feedback && feedback.length > 1) {
                    let feedbackHTML = `<strong>Feedback:</strong><p class="mt-1">${feedback}</p>`;
                    if (idealAnswerPoints && idealAnswerPoints.length > 1) {
                        feedbackHTML += `<br><strong>Key Points for an Ideal Answer:</strong><ul class="list-disc pl-5 mt-1">${idealAnswerPoints}</ul>`;
                    }
                     aiFeedback.innerHTML = feedbackHTML;
                     feedbackContainer.classList.remove('hidden');
                     feedbackContainer.classList.add('flex');
                 } else {
                    feedbackContainer.classList.add('hidden');
                    feedbackContainer.classList.remove('flex');
                 }
                 speak(nextQuestion, () => { 
                    if (isInterviewActive) {
                        startListening();
                        startNoResponseTimer();
                    }
                 });
             }
        }
 // --- Resume Upload & Text Extraction ---
async function extractTextFromResume(file) {
  const formData = new FormData();
  formData.append("file", file);

  const response = await fetch("/.netlify/functions/extractResume", {
    method: "POST",
    body: formData,
  });

  if (!response.ok) throw new Error("Failed to extract resume text");
  const data = await response.json();
  return data.text || "";
}

resumeUpload.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  resumeStatus.textContent = "Processing resume... ‚è≥";

  try {
    resumeText = await extractTextFromResume(file);
    resumeStatus.textContent = `‚úÖ Resume loaded successfully (${file.name})`;
  } catch (err) {
    console.error(err);
    resumeStatus.textContent = "‚ùå Error reading resume. Try a text or PDF file.";
  }
});



async function startInterview() {
    const jobTitle = jobTitleInput.value.trim();
    const jobDescription = jobDescriptionInput.value.trim();
    const difficulty = difficultyInput.value;
    const languageName = currentLang === 'hi' ? 'Hinglish (a mix of Hindi and English)' : 'English';

    // üîπ Include resume if uploaded
    const resumeInfo = resumeText ? `Here is the candidate's resume content:\n${resumeText}\n\n` : "";

    // üîπ Basic validation
    if (!jobDescription && !resumeText) {
        alert(translations[currentLang].alert_no_jd);
        return;
    }
    if (!recognition) {
        alert("Your browser doesn't support Speech Recognition. Please use Google Chrome.");
        return;
    }

    isInterviewActive = true;
    noResponseCounter = 0;
    showScreen('interviewScreen');
    hintBtn.classList.remove('hidden');
    feedbackContainer.classList.add('hidden');
    feedbackContainer.classList.remove('flex');

    await setupCamera();

    interviewTitle.textContent = `${jobTitle || 'Role'} Interview`;

    // üîπ Refined HR-style AI Prompt (Professional tone)
    const initialPrompt = `
You are "Alak Sharma", a professional HR interviewer from India conducting a mock interview.
You speak naturally, confidently, and politely ‚Äî using respectful Indian workplace language.
Address candidates with ‚Äúji‚Äù (e.g., ‚ÄúShivam ji‚Äù) to sound professional yet warm.

üéôÔ∏è Interview Behaviour:
1. **Introduction Phase**
   - Start with: ‚ÄúGood morning, I‚Äôm Alak Sharma, your Virtual HR for this interview.‚Äù
   - Then ask politely: ‚ÄúMay I know your full name, please?‚Äù
   - When the candidate says their name (for example, Shivam), respond like:
     ‚ÄúThank you, Shivam ji. How are you doing today?‚Äù
   - Keep tone calm and professional ‚Äî no casual words like ‚Äúnice‚Äù or ‚Äúcool‚Äù.

2. **Basic Interaction Phase**
   - Ask: ‚ÄúPlease give a brief introduction about yourself.‚Äù
   - Continue with short, respectful follow-ups such as:
     - ‚ÄúWhat motivated you to choose this field, Shivam ji?‚Äù
     - ‚ÄúCould you tell me about your current studies or role?‚Äù
   - Always maintain formal and clear phrasing.

3. **Progressive Questioning Phase**
   - Gradually move toward career-based and technical questions.
   - When the candidate mentions something (project, skill, or company), ask relevant follow-ups politely:
     ‚ÄúThat sounds interesting, Shivam ji. What challenges did you face in that project?‚Äù
   - Avoid repeating motivational lines ‚Äî keep it to-the-point.

4. **Response Format (for system integration)**
   - Each response must have 3 parts separated by ‚Äú|||‚Äù
     - **Part 1:** Short, professional feedback (1‚Äì2 sentences)
     - **Part 2:** Ideal Answer Points (2‚Äì3 concise HTML <li> items)
     - **Part 3:** Next realistic question
   - Keep every response concise and human-like.

üìã Context:
Candidate Resume: ${resumeText ? resumeText : "(No resume provided)"}
Job Title: "${jobTitle || 'Not specified'}"
Job Description: "${jobDescription || 'Not provided'}"
Difficulty: "${difficulty}"
Language: ${languageName}

Start now as Alak Sharma.
Begin with your greeting, ask the candidate‚Äôs name, and continue naturally in this professional HR tone.
Do not add emojis or long explanations.
`;



    conversationHistory = [{ role: "user", parts: [{ text: initialPrompt }] }];
    interviewLog = [];

    // üîπ Start the first AI question
    handleInterviewTurn(null);
}

        
        async function endInterview() {
            isInterviewActive = false;
            stopListening();
            window.speechSynthesis.cancel();
            clearTimeout(noResponseTimeout);
            clearTimeout(endOfSpeechTimeout);
            
            if (userStream) {
                userStream.getTracks().forEach(track => track.stop());
                userStream = null;
            }
            videoElement.classList.add('hidden');
            videoPlaceholder.classList.remove('hidden');
            aiAvatarVideo.pause();

            const jobTitle = jobTitleInput.value.trim() || 'Practice Interview';
            let status = 'Needs Improvement';

            const summaryPrompt = `Based on the following interview log, please generate a comprehensive summary report for the user in simple ${currentLang === 'hi' ? 'Hinglish' : 'English'}.
            **IMPORTANT RULE: Do not use any symbols or emojis in your report.**
            The report MUST start with a single, overall interview status. Choose one from: "Strong Hire", "Good Potential", "Needs Improvement". Wrap this status in a div with an id, like this: <div id="interview-status">Strong Hire</div>.

            After the status, the report should have two main sections.
            Format the rest of the output using simple HTML tags. Use <h2> for main titles, <h3> for subtitles, <p> for text, <strong> for highlighting, and <ul>/<li> for lists. For the ideal answer points, use the provided HTML list items. Create a container div with class 'summary-block' for each question-answer pair. Do not include <html> or <body> tags.
            1. <h2>Overall Performance</h2>: A friendly, overall summary. Highlight strengths and point out key areas for improvement constructively.
            2. <h2>Question Breakdown</h2>: For each item in the log, present the Question, the User's Answer, the Feedback, and the Ideal Answer Points in a clear, easy-to-read format inside a 'summary-block' div.
            Interview Log: ${JSON.stringify(interviewLog, null, 2)}`;
            
            showScreen('summaryScreen');
            summaryPlaceholder.style.display = 'flex';
            summaryContent.innerHTML = '';
            summaryContent.appendChild(summaryPlaceholder);

            const summaryHTML = await callGeminiAPI([{ role: "user", parts: [{ text: summaryPrompt }] }], "summary");
            if (summaryHTML) {
                summaryPlaceholder.style.display = 'none';

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = summaryHTML;

                const statusElement = tempDiv.querySelector('#interview-status');
                if (statusElement) {
                    status = statusElement.textContent.trim();
                    displayInterviewStatus(status);
                    statusElement.remove();
                }

                const finalSummaryHTML = tempDiv.innerHTML;
                summaryContent.innerHTML = finalSummaryHTML;
                saveInterviewToHistory({ title: jobTitle, date: new Date().toISOString(), status, summary: finalSummaryHTML });
            } else {
                summaryContent.innerHTML = `<p class="text-red-400">${translations[currentLang].summary_generating_error || 'Sorry, an error occurred while generating the summary.'}</p>`;
            }
        }
        
        async function handleGenerateDescription() {
            const jobTitle = jobTitleInput.value.trim();
            if (!jobTitle) { alert(translations[currentLang].alert_no_title_for_jd); return; }
            
            const originalButtonHTML = generateDescBtn.innerHTML;
            generateDescBtn.disabled = true;
            generateDescBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generating...`;
            generateDescBtn.classList.add('flex', 'items-center', 'justify-center');
            jobDescriptionInput.placeholder = translations[currentLang].status_generating_desc;
            
            const prompt = `You are an expert HR manager. Write a detailed job description for the following job title: "${jobTitle}". Include typical responsibilities, required skills, and qualifications. The description should be well-formatted and professional. Write the description in English. Do not use any symbols or emojis.`;
            
            try {
                const description = await callGeminiAPI([{ role: "user", parts: [{ text: prompt }] }], "description");
                if (description) {
                    jobDescriptionInput.value = description;
                } else {
                    jobDescriptionInput.placeholder = "Description generation failed. Please try again.";
                }
            } catch (error) {
                 console.error("Error during description generation:", error);
                 jobDescriptionInput.placeholder = "Description generation failed. Please try again.";
            } finally {
                generateDescBtn.disabled = false;
                generateDescBtn.innerHTML = originalButtonHTML;
                generateDescBtn.classList.remove('flex', 'items-center', 'justify-center');
                updateStatus('status_ready', 'waiting');
            }
        }
        
        async function handleHint() {
            if (!isInterviewActive || !currentQuestion) return;
            hintBtn.disabled = true;
            
            const prompt = `The user is stuck on the following interview question: "${currentQuestion}". Provide a brief, one-sentence hint in ${currentLang === 'hi' ? 'Hinglish' : 'English'} to help them get started without giving away the full answer. The hint should be encouraging. Do not use any symbols or emojis.`;
            const hint = await callGeminiAPI([{ role: "user", parts: [{ text: prompt }] }], "hint");
            
            if (hint) {
                aiFeedback.innerHTML = hint;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.classList.add('flex');
            }
            hintBtn.disabled = false;
            updateStatus('status_listening', 'listening');
        }

        function resetAppToHome() {
            isInterviewActive = false;
            isListening = false;
            window.speechSynthesis.cancel();
            if (userStream) {
                userStream.getTracks().forEach(track => track.stop());
                userStream = null;
            }
            showScreen('homeScreen');
            conversationHistory = [];
            interviewLog = [];
            // Do not clear job inputs, user might want to restart with same details
            setLanguage(languageSelector.value);
            updateStatus('status_waiting', 'waiting');
        }

        // --- Media Functions ---
        function setAIAvatarState(state) {
            if (aiAvatarVideo.src !== videoStates[state]) {
                aiAvatarVideo.src = videoStates[state];
            }
            if (state === 'listening' || state === 'thinking' || state === 'speaking') {
                aiAvatarVideo.play().catch(e => console.error("Video play error:", e));
            }
        }

        async function setupCamera() {
            setAIAvatarState('listening');
            try {
                userStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoElement.srcObject = userStream;
                videoElement.classList.remove('hidden');
                videoPlaceholder.classList.add('hidden');
                isMicOn = true;
                isVideoOn = true;
                updateMediaButtonUI();
            } catch (err) {
                console.error("Error accessing media devices.", err);
                alert(translations[currentLang].video_permission_error);
                isMicOn = false;
                isVideoOn = false;
                updateMediaButtonUI();
            }
        }

        function toggleMic() {
            if (!userStream) return;
            isMicOn = !isMicOn;
            userStream.getAudioTracks()[0].enabled = isMicOn;
            if (!isMicOn && isListening) {
                stopListening();
            }
            updateMediaButtonUI();
        }

        function toggleVideo() {
            if (!userStream) return;
            isVideoOn = !isVideoOn;
            userStream.getVideoTracks()[0].enabled = isVideoOn;
            videoElement.classList.toggle('hidden', !isVideoOn);
            videoPlaceholder.classList.toggle('hidden', isVideoOn);
            updateMediaButtonUI();
        }

        function updateMediaButtonUI() {
            micBtn.classList.toggle('bg-red-600', !isMicOn);
            micBtn.classList.toggle('bg-white/10', isMicOn);
            micBtn.querySelector('.mic-on-icon').classList.toggle('hidden', !isMicOn);
            micBtn.querySelector('.mic-off-icon').classList.toggle('hidden', isMicOn);

            videoBtn.classList.toggle('bg-red-600', !isVideoOn);
            videoBtn.classList.toggle('bg-white/10', isVideoOn);
            videoBtn.querySelector('.video-on-icon').classList.toggle('hidden', !isVideoOn);
            videoBtn.querySelector('.video-off-icon').classList.toggle('hidden', isVideoOn);
        }
        
        function swapVideoFeeds() {
            videoFeedContainer.classList.toggle('swapped');
        }

        // --- History & Drawer Functions (LocalStorage) ---
        function getInterviewHistory() {
            const user = netlifyIdentity.currentUser();
            if (!user) return [];
            return JSON.parse(localStorage.getItem(`interviewHistory_${user.id}`) || '[]');
        }

        function saveInterviewToHistory(interviewData) {
            const user = netlifyIdentity.currentUser();
            if (!user) return;
            const history = getInterviewHistory();
            history.unshift(interviewData); // Add new item to the beginning
            localStorage.setItem(`interviewHistory_${user.id}`, JSON.stringify(history));
        }

        function deleteInterviewFromHistory(index) {
            const user = netlifyIdentity.currentUser();
            if (!user) return;
            const history = getInterviewHistory();
            history.splice(index, 1);
            localStorage.setItem(`interviewHistory_${user.id}`, JSON.stringify(history));
            updateDrawerUI(user); // Refresh the drawer UI
        }

        function clearInterviewHistory() {
            const user = netlifyIdentity.currentUser();
            if (!user) return;
            localStorage.removeItem(`interviewHistory_${user.id}`);
            updateDrawerUI(user); // Refresh the drawer UI
        }
        
        function showHistorySummary(index) {
            const history = getInterviewHistory();
            const record = history[index];
            if (record) {
                showScreen('summaryScreen');
                displayInterviewStatus(record.status);
                summaryPlaceholder.style.display = 'none';
                summaryContent.innerHTML = record.summary;
                toggleDrawer(false);
            }
        }

        function showConfirmation(title, text, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').textContent = text;
            
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');

            const controller = new AbortController();
            const { signal } = controller;

            const close = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                controller.abort();
            };

            cancelBtn.addEventListener('click', close, { signal });
            okBtn.addEventListener('click', () => {
                onConfirm();
                close();
            }, { signal });

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function toggleDrawer(force) {
            const isOpen = force === undefined ? drawer.classList.contains('translate-x-full') : !force;
            drawer.classList.toggle('translate-x-full', isOpen);
            drawer.classList.toggle('translate-x-0', !isOpen);
            drawerBackdrop.classList.toggle('hidden', isOpen);
            drawerBackdrop.classList.toggle('opacity-0', isOpen);
            drawerBackdrop.classList.toggle('opacity-100', !isOpen);
        }

        function updateDrawerUI(user) {
            if (!user) {
                drawerContent.innerHTML = '';
                return;
            }
            
            const history = getInterviewHistory();
            let historyHTML = '';
            if (history.length > 0) {
                historyHTML = `
                    <h3 class="font-bold text-gray-700 mb-3 text-lg">Previous Interviews</h3>
                    <ul id="interview-history-list" class="space-y-2 text-sm max-h-[50vh] overflow-y-auto">
                        ${history.map((item, index) => `
                            <li class="history-item p-3 rounded-lg border border-gray-200 flex justify-between items-center hover:bg-gray-50 cursor-pointer" data-history-index="${index}">
                                <div class="flex-grow mr-2">
                                    <strong class="text-indigo-600">${item.title}</strong><br>
                                    <span class="text-xs text-gray-500">${new Date(item.date).toLocaleString()}</span>
                                </div>
                                <button class="delete-history-item p-1 text-gray-400 hover:text-red-500 transition-colors" data-delete-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                    <button id="clearHistoryBtn" class="w-full mt-4 text-xs text-red-500 hover:text-red-400 hover:underline">Clear All History</button>
                `;
            } else {
                 historyHTML = '<p class="text-center text-gray-500 mt-8">No interview history found.</p>';
            }

            drawerContent.innerHTML = `
                <div class="drawer-profile flex flex-col items-center justify-center p-6 bg-[#111827] flex-shrink-0">
                    <div class="w-24 h-24 rounded-full bg-blue-500 flex items-center justify-center border-4 border-white/20 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <h2 class="text-xl font-bold mt-4 text-white">${user.user_metadata.full_name || 'User'}</h2>
                    <p class="text-xs text-gray-400 mt-1 break-all px-2">${user.email}</p>
                </div>
                <div class="drawer-card bg-white p-6 rounded-t-2xl -mt-4 text-gray-900 flex flex-col">
                     <button id="logoutBtn" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors mb-6 shadow-md hover:shadow-lg">Logout</button>
                     ${historyHTML}
                </div>
            `;
            
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                toggleDrawer(false);
                netlifyIdentity.logout();
            });

            if (history.length > 0) {
                document.getElementById('clearHistoryBtn')?.addEventListener('click', () => {
                    showConfirmation('Clear All History?', 'This will permanently delete all your interview records.', clearInterviewHistory);
                });

                document.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-history-item')) return;
                        showHistorySummary(e.currentTarget.dataset.historyIndex);
                    });
                });

                document.querySelectorAll('.delete-history-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = e.currentTarget.dataset.deleteIndex;
                        showConfirmation('Delete Interview?', 'This interview record will be permanently deleted.', () => deleteInterviewFromHistory(index));
                    });
                });
            }
        }
        
        // --- Netlify Identity Logic ---
        if (window.netlifyIdentity) {
            function updateHeaderUI(user) {
                if (user) {
                    const avatarUrl = user.user_metadata.avatar_url;
                    let profileBtnHTML = avatarUrl 
                        ? `<img src="${avatarUrl}" class="w-10 h-10 rounded-full border-2 border-blue-400 object-cover">`
                        : `<div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center border-2 border-blue-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></div>`;

                    headerAuthSection.innerHTML = `<button id="profile-icon-btn">${profileBtnHTML}</button>`;
                    document.getElementById('profile-icon-btn').addEventListener('click', () => toggleDrawer(true));
                } else {
                    headerAuthSection.innerHTML = `<button id="header-login-btn" class="header-login-btn">Login</button>`;
                    document.getElementById('header-login-btn').addEventListener('click', () => netlifyIdentity.open());
                }
            }

            netlifyIdentity.on('init', user => {
                updateHeaderUI(user);
                updateDrawerUI(user);
            });

            netlifyIdentity.on('login', user => {
                netlifyIdentity.close();
                updateHeaderUI(user);
                updateDrawerUI(user);
                if (loginAndStart) {
                    loginAndStart = false;
                    showScreen('setupScreen');
                }
            });

            netlifyIdentity.on('logout', () => {
                updateHeaderUI(null);
                updateDrawerUI(null);
                resetAppToHome();
            });
        }

        // --- Event Listeners & Init ---
        languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
        
        startInterviewHomeBtn.addEventListener('click', () => {
            const user = netlifyIdentity.currentUser();
            if (user) {
                showScreen('setupScreen');
            } else {
                loginAndStart = true;
                netlifyIdentity.open();
            }
        });

        startInterviewBtn.addEventListener('click', startInterview);
        
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            resetAppToHome();
        });

        endInterviewBtn.addEventListener('click', endInterview);
        restartBtn.addEventListener('click', () => showScreen('setupScreen'));
        generateDescBtn.addEventListener('click', handleGenerateDescription);
        hintBtn.addEventListener('click', handleHint);
        drawerBackdrop.addEventListener('click', () => toggleDrawer(false));
        
        micBtn.addEventListener('click', toggleMic);
        videoBtn.addEventListener('click', toggleVideo);
        userVideoContainer.addEventListener('click', swapVideoFeeds);
        aiVideoContainer.addEventListener('click', swapVideoFeeds);

        featuresLink.addEventListener('click', (e) => {
            e.preventDefault();
            featuresModal.classList.remove('hidden');
            featuresModal.classList.add('flex');
        });

        closeFeaturesModalBtn.addEventListener('click', () => {
             featuresModal.classList.add('hidden');
            featuresModal.classList.remove('flex');
        });

        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        mobileHomeLink.addEventListener('click', (e) => {
            e.preventDefault();
            resetAppToHome();
            mobileMenu.classList.add('hidden');
        });

        mobileFeaturesLink.addEventListener('click', (e) => {
            e.preventDefault();
            featuresModal.classList.remove('hidden');
            featuresModal.classList.add('flex');
            mobileMenu.classList.add('hidden');
        });

        if (recognition) {
            recognition.onresult = (e) => {
                clearTimeout(noResponseTimeout); // Clear no-response timer as soon as user speaks
                noResponseCounter = 0;

                let finalTranscript = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
                }
                if (finalTranscript) {
                    userTranscript.textContent = finalTranscript;
                }
                clearTimeout(endOfSpeechTimeout);
                endOfSpeechTimeout = setTimeout(() => {
                    if (isListening) {
                        stopListening();
                        const currentTranscript = userTranscript.textContent.trim();
                        if (currentTranscript && currentTranscript !== '...' && currentTranscript !== translations[currentLang].transcript_placeholder) {
                            handleInterviewTurn(currentTranscript);
                        } else {
                            speak(translations[currentLang].status_no_speech, () => {
                                if (isInterviewActive) {
                                    userTranscript.textContent = translations[currentLang].transcript_placeholder;
                                    startListening();
                                    startNoResponseTimer();
                                }
                            });
                        }
                    }
                }, 4000); // Increased timeout to 4 seconds
            };

            recognition.onerror = (e) => {
                console.error("Speech recognition error:", e.error);
                isListening = false;
                let errorKey = 'An unknown error occurred.';
                if (e.error === 'network') errorKey = 'status_network_error';
                else if (e.error === 'no-speech' && isInterviewActive) {
                    // This is handled by the noResponseTimeout now, so we can ignore this specific error
                    return; 
                } 
                else if (e.error === 'audio-capture' || e.error === 'not-allowed') errorKey = 'status_mic_error';
                updateStatus(errorKey, 'error');
            };
            
            recognition.onend = () => {
                if (isInterviewActive && isListening) {
                    isListening = false;
                    startListening();
                } else {
                    isListening = false;
                }
            };
        }

        // --- App Initialization ---
        window.addEventListener('load', () => {
            setLanguage(languageSelector.value);
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = setupSpeechSynthesis;
            }
            updateStatus('status_waiting', 'waiting');
            showScreen('homeScreen');
        });

    </script>
</body>
</html>
